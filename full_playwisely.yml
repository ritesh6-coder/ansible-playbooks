---
- name: Fully rename an ESXi VM (folder + internal files)
  hosts: 192.168.223.131
  gather_facts: no
  vars:
    old_vm_name: "{{ vm_name }}"                         # Input: current VM folder and base name
    new_vm_name: "{{ vm_name }}-renamed"                 # Default new name (can be overridden)
    datastore: "datastore1"
    datastore_path: "/vmfs/volumes/{{ datastore }}"
    old_path: "{{ datastore_path }}/{{ old_vm_name }}"
    new_path: "{{ datastore_path }}/{{ new_vm_name }}"
  tasks:

    - name: Get VM ID by filtering all VMs on ESXi
      shell: "vim-cmd vmsvc/getallvms | grep '{{ old_vm_name }}' | awk '{print $1}'"
      register: vm_id_output
      failed_when: vm_id_output.stdout == ""              # Fail if VM ID is not found
      changed_when: false

    - name: Set VM ID fact for reuse in playbook
      set_fact:
        vm_id: "{{ vm_id_output.stdout.strip() }}"

    - name: Power off the VM if it is powered on
      shell: |
        if vim-cmd vmsvc/power.getstate {{ vm_id }} | grep -q "Powered on"; then
          vim-cmd vmsvc/power.off {{ vm_id }}
        fi
      changed_when: true

    - name: Unregister VM from ESXi inventory (remove registration)
      shell: vim-cmd vmsvc/unregister {{ vm_id }}

    - name: Rename VM folder on datastore
      shell: mv "{{ old_path }}" "{{ new_path }}"

    - name: Rename internal VM files to new VM name
      shell: |
        cd "{{ new_path }}"
        for file in *; do
          newfile=$(echo "$file" | sed "s/{{ old_vm_name }}/{{ new_vm_name }}/g")
          if [ "$file" != "$newfile" ]; then
            mv "$file" "$newfile"
          fi
        done

    - name: Update displayName in .vmx config file to new VM name
      shell: |
        sed -i 's/displayName = \".*\"/displayName = \"{{ new_vm_name }}\"/' "{{ new_path }}/{{ new_vm_name }}.vmx"
        sed -i "s/{{ old_vm_name }}/{{ new_vm_name }}/g" "{{ new_path }}/{{ new_vm_name }}.vmx"

    - name: Update .vmsd file if exists to reflect new VM name
      shell: |
        if [ -f "{{ new_path }}/{{ new_vm_name }}.vmsd" ]; then
          sed -i "s/{{ old_vm_name }}/{{ new_vm_name }}/g" "{{ new_path }}/{{ new_vm_name }}.vmsd"
        fi
      ignore_errors: true

    - name: Register renamed VM to ESXi inventory
      shell: vim-cmd solo/registervm "{{ new_path }}/{{ new_vm_name }}.vmx"
      register: register_output

    - name: Extract new VM ID after registration
      shell: "vim-cmd vmsvc/getallvms | grep '{{ new_vm_name }}' | awk '{print $1}'"
      register: new_vm_id_output
      failed_when: new_vm_id_output.stdout == ""
      changed_when: false

    - name: Set new VM ID fact
      set_fact:
        new_vm_id: "{{ new_vm_id_output.stdout.strip() }}"

    - name: Take snapshot after rename and registration
      shell: >
        vim-cmd vmsvc/snapshot.create {{ new_vm_id }}
        "post-rename-backup" "Snapshot after full rename to {{ new_vm_name }}" 0 0

    - name: (Optional) Power on the VM after rename
      shell: vim-cmd vmsvc/power.on {{ new_vm_id }}

    - name: List all VMs to confirm rename
      shell: vim-cmd vmsvc/getallvms
      register: final_vm_list
      changed_when: false

    - name: Show final VM list after rename
      debug:
        msg: "{{ final_vm_list.stdout_lines }}"

